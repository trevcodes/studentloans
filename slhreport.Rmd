---
title: Making Sense of $1.3T in Student Loan Debt - An Analysis of Student Loan Hero
  Users'  and Predictive Default Model
author: "Trevor Ford"
date: "February 17, 2018"
output: 
  github_document:
    toc: yes
    toc_depth: '3'
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: 3
  
---
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE)
```


```{r, include=FALSE}
library(dplyr) #dplyr package import
library(plyr)
library(lubridate) #lubridate (For working with date variables)
library(ggplot2) # for plotting
library(magrittr) 
library(RecordLinkage)
library(stringdist)
library(readr)
library(choroplethr)
library(choroplethrMaps)
library(ggthemes)
library(scales)
library(dplyr)
library(ggplot2)
library(data.table)
library(lubridate)
library(randomForest)
library(caret)
library(formatR)
library(ROSE)
library(pROC)
library(verification)
setwd('C:\\Users\\Trevor\\Downloads\\slhloansreport')
slhloans <- read.csv("loans_final_userid.csv")
```

# Introduction

Student loan debt is a $1.3T problem facing over 44 million Americans.  The average 2016 graduate left college with over $37,000 of debt and is burdened with over $350 a month in student loan payments.  Student Loan Hero was conceived as a resource to help student loan borrowers understand the various student loan repayment schemes, navigate the numerous federal programs designed to help borrowers with their loans, and recommend ways for borrowers to save money on their loans.  Student Loan Hero developed a proprietary tool that aggregates all of a borrower\'s loans and displays the details all in one place, then generates a customized repayment plan based on each borrower\'s unique circumstances.  To date, the tool has analyzed over $2 billion worth of student loan debt and helped 50,000 plus borrowers best pay off their student loans.  This course offered the perfect opportunity to explore the vast amount of borrower data gathered in the three years Student Loan Hero has been operating.

## The Goal

Student loan delinuency and default rates are on the rise, the past four straight quarters have witnessed student loan repayment delinquencies increasing with little public consensus as to why.  Student loan debt as a whole affects the economy in a number of ways.  41% of student loan borrowers have reported they've delayed homeownership as a result of excessive student loan debt, contributing to a housing market slowdown.  Would-be entrepreneurs are also admitting that student loans are holding them back from starting new businesses.  When borrowers do default on their student loans they face a myriad of consequences.  Defaulting borrowers lose all potential federal student loan protections including access to programs such as forbearance, deferment, and any forgiveness programs.  Defaulters will also see their credit scores negatively impacted which could negatively impact a borrower\'s eligbility for any new loans.  Defaulters may also see their paychecks garneshed by the government, have collection fees and added interest tacked on to their existing balances, and could have legal actions taken against them.  

![Student Loan Default Rates](https://studentloanhero.com/wp-content/uploads/92a597c3-805a-4237-b804-6fc9fa9f0236_Screen20Shot202017-09-2920at208.51.2920AM.png)

By using a binary classification machine learning algorithm we hope to be able to predict whether a given borrower is likely to default on their student loans.  The business application of being able to accurately make this prediction is if a borrower is likely to default on their student loans, Student Loan Hero has the opportunity to connect with high-risk borrowers and help those borrowers take appropriate action to avoid default.


# Datasets
##Student Loan Hero User Dataset

The private Student Loan Hero User dataset contains data from 24,000 anonymized student loans along with various details of the user's university data such as the user's major, college attended, along with post-graduation data such as current salary, current profession, and credit score.  It also contains specific loan details such as interest rate, disbursement date, and original principal.

```{r slhloans}
names(slhloans)
```


## Carnegie Mellon University Classifications

The Carnegie Mellon University Classification dataset is a framework for categorizing and classifying United States institutes of higher education.  All Title IV colleges and universities are listed along with accompanying classifying data including attributes such as enrollment profiles (demographics, student statuses, etc), university size and setting, any unique university characteristics such as whether the school is a technical or vocational school, historically black colleges and universities, women's only universities, etc.  This dataset was desired for categorizing the hundreds of universities Student Loan Hero Users have attended into smaller buckets of for the binary classification machine learning algorithm used to predict whether a user will default on their student loans.
```{r}
univ <- read.csv("collegedetails.csv")
names(univ)
```

# Preparing and Cleaning Datasets

Since the goal of this project is to predict the likelihood a borrower will default on their loans by the use of a binary classification machine learning model it was imperative to narrow the number of levels in a number of factors in the Student Loan Hero dataset.

## Status
The most important factor to isolate and address is the loan "status", this factor contains all statuses a borrower's loan could be in, for Student Loan Hero users.  This will be our target factor for our binary classification machine learning algorithm..
```{r}
str(slhloans$Status)
head(levels(factor(slhloans$Status)))
```
This factor with 149 levels needed to be reduced to just two levels for the purposes of the desired machine learning algorithm.  A borrower's loan should fall into one of two statuses, either in "Repayment" or in "Default".  This meant first breaking down the statuses by frequency, identifying duplicate but misnamed levels, and merging levels that had similar meanings.

```{r, echo=FALSE}
slhloans$Status <- as.character(slhloans$Status)

slhloans$Status[grep(".*defer.*", slhloans$Status,ignore.case = TRUE)] <- "RPM"
slhloans$Status[grep(".*Originated.*|.*in school.*", slhloans$Status,ignore.case = TRUE)] <- "RPM"
slhloans$Status[grep(".*repayment.*", slhloans$Status,ignore.case = TRUE)] <- "RPM"
slhloans$Status[grep(".*grace.*", slhloans$Status,ignore.case = TRUE)] <- "RPM"
slhloans$Status[grep(".*default.*", slhloans$Status,ignore.case = TRUE)] <- "Default"
slhloans$Status[grep(".*forbearance.*|.*forb.*", slhloans$Status,ignore.case = TRUE)] <- "RPM"
slhloans$Status[grep(".*bankruptcy.*", slhloans$Status,ignore.case = TRUE)] <- "Default"
slhloans$Status[grep(".*delinq.*", slhloans$Status,ignore.case = TRUE)] <- "Default"
slhloans$Status[grep(".*CANCEL.*|.*Custom.*|.*interest only.*", slhloans$Status,ignore.case = TRUE)] <- "RPM"

```

```{r}
levels(factor(slhloans$Status))
```
## Major

Cleaning the major'\s obtained by borrowers was necessay to undertake since the non-standardized factor had over 1,300 different entries, the majority of which were duplicative in nature (for example, one borrower's degree read "International Studies" while another's read "Int'l Studies").
```{r}
str(slhloans$Major)
```

Condensing the majors to the most frequently occuring and a basket titled "others" for any other majors made this factor much easier to work with.

```{r, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
levels(slhloans$Major) <- gsub(".*Law.*|.*Lawyer.*|.*attorney.*|.*JD.*|.*Juris Doctor.*|.*Paralegal.*", "Law", levels(slhloans$Major))
levels(slhloans$Major) <- gsub(".*Business.*|.*Financ.*|.*Account.*|.*Economic.*|.*Marketing.*|.*Human Resources.*", "Business", levels(slhloans$Major))
levels(slhloans$Major) <- gsub(".*Philosophy.*|.*Social.*|.*Politic.*|.*English.*|.*History.*|.*Sociology.*|.*International.*|.*General Studies.*|.*Fashion.*", "Liberal Arts", levels(slhloans$Major))
levels(slhloans$Major) <- gsub(".*Engineer.*", "Engineering", levels(slhloans$Major))
levels(slhloans$Major) <- gsub(".*Medicine.*|.*MD.*|.*Physician*|.*Doctor.*|.*Pharmacy.*|.*Medical.*|.*medicine.*", "Higher Medical Degree", levels(slhloans$Major))
levels(slhloans$Major) <- gsub(".*Teach.*|.*Education.*|.*Teach.*", "Education", levels(slhloans$Major))
levels(slhloans$Major) <- gsub(".*Technology.*|.*Computer.*|.*Systems.*", "Computer Science", levels(slhloans$Major))
levels(slhloans$Major) <- gsub(".*Communication.*|.*Relations.*", "Communications", levels(slhloans$Major))
levels(slhloans$Major) <- gsub(".*Science.*|.*Biology.*|.*Chemistry.*|.*Geology.*|.*Bioengineer.*|.*Physics.*|.*Mathematics.*", "Sciences", levels(slhloans$Major))
levels(slhloans$Major) <- gsub(".*Psychology.*", "Psychology", levels(slhloans$Major))
levels(slhloans$Major) <- gsub("Art|.*Graphic.*|.*Film.*|.*Drama.*|.*Music.*|.*Photography.*", "Arts", levels(slhloans$Major))
levels(slhloans$Major) <- gsub(".*Nurs.*|.*nurs.*", "Nursing", levels(slhloans$Major))

OtherMajors <- !(slhloans$Major %in% c("Business","Sciences", "Higher Medical Degree", "Engineering", "Liberal Arts", "Law", "Education", "Nursing", "Psychology", "Communications", "MBA"))

slhloans$Major[OtherMajors]<- "Other"

slhloans$Major <- factor(slhloans$Major)

levels(slhloans$Major)
```


## Profession
Cleaning the profession's of borrowers again was important since to start borrowers had self-identified into over 1800 different professions.  
```{r}
str(slhloans$Profession)
```
By first merging duplicative or identical professions (example: accountant, certified public accountant) and then analyzing the most frequently occuring professions the profession level was narrowed to ten of the most occurring professions and a catchall category of "Other" for all other professions.
```{r}
levels(slhloans$Profession) <- gsub(".*Lawyer.*|.*attorney.*", "Attorney", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Engineer.*", "Engineer", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Teacher.*", "Teacher", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Nurse.*", "Doctor/Nurse/Pharmacist", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Doctor.*", "Doctor/Nurse/Pharmacist", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Therapist.*", "Doctor/Nurse/Pharmacist", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Physician.*", "Doctor/Nurse/Pharmacist", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Dentist.*", "Doctor/Nurse/Pharmacist", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Dental.*", "Doctor/Nurse/Pharmacist", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Physician's.*", "Doctor/Nurse/Pharmacist", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Psychologist.*", "Doctor/Nurse/Pharmacist", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Psychiatrist.*", "Doctor/Nurse/Pharmacist", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Medical.*", "Doctor/Nurse/Pharmacist", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Chiropractor.*", "Doctor/Nurse/Pharmacist", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Pharmacist.*", "Doctor/Nurse/Pharmacist", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Nursing.*", "Doctor/Nurse/Pharmacist", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Computer.*", "Computer/Tech", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Developer.*", "Computer/Tech", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*IT.*", "Computer/Tech", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Teacher.*", "Teacher", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Librarian.*", "Teacher", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Professor.*", "Teacher", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Accounting.*", "Accountant", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Student.*|.*Resident.*|.*Researcher.*|.*student.*", "Student", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Designer.*|.*Graphic.*", "Designer", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Business.*|.*Manager.*|.*Marketing.*|.*Financial.*|.*Analyst.*|.*Insurance.*|.*Consultant*.|.*Resources.*|.*Consulting.*", "General Business", levels(slhloans$Profession))
levels(slhloans$Profession) <- gsub(".*Retail.*|.*Cashier.*", "Retail", levels(slhloans$Profession))

OtherProfessions <- !(slhloans$Profession %in% c("Doctor/Nurse/Pharmacist","General Business", "Engineer", "Attorney", "Teacher", "Computer/Tech", "Accountant", "Student", "Designer", "Retail"))

slhloans$Profession[OtherProfessions]<- "Other"

slhloans$Profession <- factor(slhloans$Profession)

```

```{r}
levels(factor(slhloans$Profession))
```

## Other Factors

By using domain knowledge of the US student loan industry,the "Servicer" factor was removed as it should have no bearing on whether a borrower will default or not.

#Exploratory Data Analysis

In examning the new cleaned data set, we can see we have a fairly unbalanced data set with the majority of borrowers in "repayment" and only a handful in "default".
```{r}
slhloans%>%group_by(Status)%>% dplyr::summarise(Count=n())

```

##Loans in repayment and default by degree type

Before we can take a look at a cohort analysis of loan status by degree types a few steps had to be taken first.

In order to better understand where users are in their journey of paying off their student loan debt, a column calculating the difference between the original loan's balance and the current loan's balance was added.

```{r}
#adding a new calculated column = difference between original and current principal

slhloans <- mutate(slhloans, Difference=Current.Principal-Original.Principal)

summary(slhloans$Difference)
```

To ensure we're only analyzing loans with a positive balance present, I used the reviously calculated "difference" column to filter out any zero-balance loans. 

```{r}
#Using only records where difference is positive, and rate is >0
slhloans <- filter(slhloans, Difference>=0&Rate>0)
```

To ensure only loans where there was an initial balance added by the user, any loans with an original balance of 0 were removed.

```{r}

#getting rid of records where original principal is 0
slhloans <- filter(slhloans, Original.Principal>0)
```

Now that we have filtered out null and errantly-balanced loans, we can take a look at the distribution of degrees, and the status of student loans by those different degrees.

```{r}
ggplot(slhloans, aes(Education.Degree, fill=Status))+theme_fivethirtyeight()+geom_bar()+theme(legend.position = "right", legend.direction = "vertical",axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_manual(values=c("#DE6449", "#00b9f1"))
```



##Loan disbursement distribution by year

Since the database where the loans was held had a non-standardized date field, it was necessary to standardize the date using lubridate.  Once luubriated, the dates were converted to a format where calculations could be performed on them.

```{r}
#Lubridating the date field from character to true date field
slhloans$Loan.Disbursement.Date <- mdy(slhloans$Loan.Disbursement.Date)

```

Taking a look at the distribution of years when the users' loans were disbursed 
```{r echo=FALSE}
#yearwise breakdown of loans disbursed
yearwise <- slhloans%>%group_by(year(Loan.Disbursement.Date))%>%dplyr::summarize(Count=n())

```

```{r}
yearwise_desc <- arrange(yearwise, desc(Count))

colnames(yearwise) <- c("year", "count")

ggplot(yearwise, (aes(x = year, y = count, fill = count))) + geom_bar(stat="identity") + scale_fill_gradient(low = "yellow", high = "red")

```


##Student Loan Hero users by state


##Blending Carnegie Mellon University Classifications Dataset with Student Loan Hero Users Dataset

To better bucket the colleges and universities Student Loan Hero users attended for our classification algorithm 11 attributes from the Carnegie Mellon University Calssification dataset were added to the Student Loan Hero users dataset.  

```{r}
univ <- read.csv("collegedetails.csv")
summary(univ)
```

Once the Carnegie Mellon University Classification dataset was imported, the classifiers that were to be used for further analysis and matched up with the universities of SLH users were imported, including data such as the location (state and region) of university, type of university (is this a medical school, liberal arts school, womens school, etc).

```{r}
cleanloans <- read.csv("slhloansclean.csv")
cleanloans$univctrl <- univ[match(cleanloans$College, univ$NAME),4]
cleanloans$univstate <- univ[match(cleanloans$College, univ$NAME),3]
cleanloans$univobereg <- univ[match(cleanloans$College, univ$NAME),5]
cleanloans$univlocale <- univ[match(cleanloans$College, univ$NAME),6]
cleanloans$univenrprofile <- univ[match(cleanloans$College, univ$NAME),8]
cleanloans$univmedical <- univ[match(cleanloans$College, univ$NAME),9]
cleanloans$univhbcu <- univ[match(cleanloans$College, univ$NAME),10]
cleanloans$univtribal <- univ[match(cleanloans$College, univ$NAME),11]
cleanloans$univhsi <- univ[match(cleanloans$College, univ$NAME),12]
cleanloans$univwomens <- univ[match(cleanloans$College, univ$NAME),14]
cleanloans$univlibarts <- univ[match(cleanloans$College, univ$NAME),15]
```

univctrl = University Control (Private not-for-profit University, Private for-profit University, Public University)  
univstate = State University is located  
univobereg = Region Code (New England, Mid-East, Great Lakes, Plains, Southeast, Southwest, Rocky Mountains, Far West, Outlying Areas)  
univlocale = Degree of urbanization (How large is the town or city the university is located in)  
univenrprofile = Profile of the university's enrollment (Exclusively undergraduate two-year, Exclusively undergraduate four-year, Very high undergraduate, High undergraduate, Majority undergraduate, Majority graduate, Exclusively graduate)  
univmedical = Yes/No - Does the institution grant a medical degree (MD, DDS, DMD, DO, DVM)  
univhbcu = Yes/No - is the university a historically black college or university  
univtribal = Yes/No - is the university a tribal college  
univhsi = Yes/No - is the university a hispanic serving insitute  
univwomens = Yes/No - is the university a women's only institute  
univlibarts = Yes/No - is the university a Council of Public Liberal Arts Colleges Member  




```{r, echo=FALSE, results='HIDE'}
#More Cleaning

levels(cleanloans$Major) <- gsub(".*Law.*|.*Lawyer.*|.*attorney.*|.*JD.*|.*Juris Doctor.*|.*Paralegal.*", "Law", levels(cleanloans$Major))
levels(cleanloans$Major) <- gsub(".*Business.*|.*Financ.*|.*Account.*|.*Economic.*|.*Marketing.*|.*Human Resources.*", "Business", levels(cleanloans$Major))
levels(cleanloans$Major) <- gsub(".*Philosophy.*|.*Social.*|.*Politic.*|.*English.*|.*History.*|.*Sociology.*|.*International.*|.*General Studies.*|.*Fashion.*", "Liberal Arts", levels(cleanloans$Major))
levels(cleanloans$Major) <- gsub(".*Engineer.*", "Engineering", levels(cleanloans$Major))
levels(cleanloans$Major) <- gsub(".*Medicine.*|.*MD.*|.*Physician*|.*Doctor.*|.*Pharmacy.*|.*Medical.*|.*medicine.*", "Higher Medical Degree", levels(cleanloans$Major))
levels(cleanloans$Major) <- gsub(".*Teach.*|.*Education.*|.*Teach.*", "Education", levels(cleanloans$Major))
levels(cleanloans$Major) <- gsub(".*Technology.*|.*Computer.*|.*Systems.*", "Computer Science", levels(cleanloans$Major))
levels(cleanloans$Major) <- gsub(".*Communication.*|.*Relations.*", "Communications", levels(cleanloans$Major))
levels(cleanloans$Major) <- gsub(".*Science.*|.*Biology.*|.*Chemistry.*|.*Geology.*|.*Bioengineer.*|.*Physics.*|.*Mathematics.*", "Sciences", levels(cleanloans$Major))
levels(cleanloans$Major) <- gsub(".*Psychology.*", "Psychology", levels(cleanloans$Major))
levels(cleanloans$Major) <- gsub("Art|.*Graphic.*|.*Film.*|.*Drama.*|.*Music.*|.*Photography.*", "Arts", levels(cleanloans$Major))
levels(cleanloans$Major) <- gsub(".*Nurs.*|.*nurs.*", "Nursing", levels(cleanloans$Major))

OtherMajors <- !(cleanloans$Major %in% c("Business","Sciences", "Higher Medical Degree", "Engineering", "Liberal Arts", "Law", "Education", "Nursing", "Psychology", "Communications", "MBA"))

cleanloans$Major[OtherMajors]<- "Other"

cleanloans$Major <- factor(cleanloans$Major)

#levels(cleanloans$Major)
```
```{r echo=FALSE, results='HIDE'}

cleanloans$Status[grep("forbearance",cleanloans$Status,ignore.case = TRUE)] <- "FBR"

#levels(factor(cleanloans$Status)) #prints number of unique levels in status column

#further reducing duplicative levels
cleanloans$Status[grep("deferment", cleanloans$Status,ignore.case = TRUE)] <- "DFR"
cleanloans$Status[grep("repayment", cleanloans$Status,ignore.case = TRUE)] <- "RPM"
cleanloans$Status[grep("grace", cleanloans$Status,ignore.case = TRUE)] <- "grace"
cleanloans$Status[grep("default", cleanloans$Status,ignore.case = TRUE)] <- "default"

levels(cleanloans$Status) <- gsub(".*DEFERRED.*", "DFR", ignore.case = TRUE, levels(cleanloans$Status))
levels(cleanloans$Status) <- gsub(".*DEFERMENT.*", "DFR", ignore.case = TRUE, levels(cleanloans$Status))
levels(cleanloans$Status) <- gsub(".*repayment.*", "RPM", ignore.case = TRUE, levels(cleanloans$Status))
levels(cleanloans$Status) <- gsub(".*Grace.*", "DFR", ignore.case = TRUE, levels(cleanloans$Status))
levels(cleanloans$Status) <- gsub(".*default.*", "Default", ignore.case = TRUE, levels(cleanloans$Status))
levels(cleanloans$Status) <- gsub(".*forbearance.*", "DFR", ignore.case = TRUE, levels(cleanloans$Status))
levels(cleanloans$Status) <- gsub(".*bankruptcy.*", "Default", ignore.case = TRUE, levels(cleanloans$Status))
levels(cleanloans$Status) <- gsub(".*delinq.*", "Default", ignore.case = TRUE, levels(cleanloans$Status))
levels(cleanloans$Status) <- gsub(".*rpm.*", "RPM", ignore.case = TRUE, levels(cleanloans$Status))
levels(cleanloans$Status) <- gsub(".*defer.*", "DFR", ignore.case = TRUE, levels(cleanloans$Status))
levels(cleanloans$Status) <- gsub(".*Forb.*", "DFR", ignore.case = TRUE, levels(cleanloans$Status))
levels(cleanloans$Status) <- gsub(".*In school.*", "In School", ignore.case = TRUE, levels(cleanloans$Status))


#levels(cleanloans$Status) <- gsub("DEFERRED", "DFR", levels(cleanloans$Status))
levels(cleanloans$Status) <- gsub("LOAN ORIGINATED", "IN SCHOOL", levels(cleanloans$Status))
levels(cleanloans$Status) <- gsub("FBR", "DFR", levels(cleanloans$Status))
levels(cleanloans$Status) <- gsub("grace", "DFR", levels(cleanloans$Status))
levels(cleanloans$Status) <- gsub("DFR", "DFR/GRC", levels(cleanloans$Status))
levels(cleanloans$Status) <- gsub("DFR/GRC/GRC", "DFR/GRC", levels(cleanloans$Status))

#levels(factor(cleanloans$Status)) #checking number of levels now

```
```{r echo=FALSE, results='hide'}
#Cleaning up the Professions
#head(levels(cleanloans$Profession))

#head(sort(table(cleanloans$Profession)))

levels(cleanloans$Profession) <- gsub(".*Lawyer.*|.*attorney.*", "Attorney", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Engineer.*", "Engineer", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Teacher.*", "Teacher", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Nurse.*", "Doctor/Nurse/Pharmacist", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Doctor.*", "Doctor/Nurse/Pharmacist", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Therapist.*", "Doctor/Nurse/Pharmacist", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Physician.*", "Doctor/Nurse/Pharmacist", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Dentist.*", "Doctor/Nurse/Pharmacist", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Dental.*", "Doctor/Nurse/Pharmacist", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Physician's.*", "Doctor/Nurse/Pharmacist", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Psychologist.*", "Doctor/Nurse/Pharmacist", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Psychiatrist.*", "Doctor/Nurse/Pharmacist", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Medical.*", "Doctor/Nurse/Pharmacist", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Chiropractor.*", "Doctor/Nurse/Pharmacist", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Pharmacist.*", "Doctor/Nurse/Pharmacist", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Nursing.*", "Doctor/Nurse/Pharmacist", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Computer.*", "Computer/Tech", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Developer.*", "Computer/Tech", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*IT.*", "Computer/Tech", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Teacher.*", "Teacher", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Librarian.*", "Teacher", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Professor.*", "Teacher", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Accounting.*", "Accountant", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Student.*|.*Resident.*|.*Researcher.*|.*student.*", "Student", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Designer.*|.*Graphic.*", "Designer", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Business.*|.*Manager.*|.*Marketing.*|.*Financial.*|.*Analyst.*|.*Insurance.*|.*Consultant*.|.*Resources.*|.*Consulting.*", "General Business", levels(cleanloans$Profession))
levels(cleanloans$Profession) <- gsub(".*Retail.*|.*Cashier.*", "Retail", levels(cleanloans$Profession))
OtherProfessions <- !(cleanloans$Profession %in% c("Doctor/Nurse/Pharmacist","General Business", "Engineer", "Attorney", "Teacher", "Computer/Tech", "Accountant", "Student", "Designer", "Retail"))

cleanloans$Profession[OtherProfessions]<- "Other"

cleanloans$Profession <- factor(cleanloans$Profession)

#levels(factor(cleanloans$Profession))

#removing servicer column - unnecessary for predicting the chance a borrower will default
cleanloans$Servicer <- NULL
```

##Further Data Manipulation
Once the Carnegie Mellon University Classification dataset's key columns were added to our existing Student Loan Hero dataset it was necessary to re-format and add new columns to match the data imported.  For example, the bucketed geographic data imported from the Carnegue Mellon University dataset was segmented by "region" and not "state" as the Student Loan Hero dataset had been segmented.

```{r}
#change borrower home state to obereg to match the university state obereg

levels(cleanloans$State.of.Residency) <- gsub("VT|CT|ME|MA|NH|RI", "1", levels(cleanloans$State.of.Residency))
levels(cleanloans$State.of.Residency) <- gsub("DE|DC|MD|NJ|NY|PA", "2", levels(cleanloans$State.of.Residency))
levels(cleanloans$State.of.Residency) <- gsub("IL|IN|MI|OH|WI", "3", levels(cleanloans$State.of.Residency))
levels(cleanloans$State.of.Residency) <- gsub("IA|KS|MN|MO|NE|ND|SD", "4", levels(cleanloans$State.of.Residency))
levels(cleanloans$State.of.Residency) <- gsub("AL|AR|FL|GA|KY|LA|MS|NC|SC|TN|VA|WV", "5", levels(cleanloans$State.of.Residency))
levels(cleanloans$State.of.Residency) <- gsub("AZ|NM|OK|TX", "6", levels(cleanloans$State.of.Residency))
levels(cleanloans$State.of.Residency) <- gsub("CO|ID|MT|UT|WY", "7", levels(cleanloans$State.of.Residency))
levels(cleanloans$State.of.Residency) <- gsub("AK|CA|HI|NV|OR|WA", "8", levels(cleanloans$State.of.Residency))
levels(cleanloans$State.of.Residency) <- gsub("AS|FM|GU|MH|MP|PR|PW|VI", "9", levels(cleanloans$State.of.Residency))

```



```{r echo=FALSE, results='hide'}
#adding a new calculated column = difference between original and current principal
cleanloans <- mutate(cleanloans, Difference=Current.Principal-Original.Principal)

summary(cleanloans$Difference)

#Pulling records where difference is positive, and rate is >0
cleanloans <- filter(cleanloans, Difference>=0&Rate>0)

#Removing records where original principal is 0
cleanloans <- filter(cleanloans, Original.Principal>0)

#Lubridating the date field from character to true date field
cleanloans$Loan.Disbursement.Date <- mdy(cleanloans$Loan.Disbursement.Date)

#Adding new column for each user's original balance sum
cleanloans$Original.Principal[is.na(cleanloans$Original.Principal)] <- 0
cleanloans <- cleanloans %>% group_by(User.ID..) %>% mutate(origtotalbalance=sum(Original.Principal))
#Adding new column for each user's current balance sum
cleanloans$Current.Principal[is.na(cleanloans$Current.Principal)] <- 0
cleanloans <- cleanloans %>% group_by(User.ID..) %>% mutate(currenttotalbalance=sum(Current.Principal))%>% mutate(origtotalbalance=sum(Original.Principal))

```

Student loans in the United States of America can fall into two categories, private or federal.  Private student loans are originated from banks and lending institutions not associated with any student assistance offered by the US government.  Federal student loans are typically part of a student's financial aid package when attending a college and are primarily needs-based.  The Student Loan Hero database had the full names of each student loan, but for the purposes of our desired binary classification machine learning algorithm to predict whether a user is likely to default we needed the category to be narrowed down to the broadest category of loan they would fall in - private or federal.

```{r}

#Cleaning up Loan Names to just 2 type: Federal Loans or Private Loans
head(levels(cleanloans$Name))

levels(cleanloans$Name) <- gsub(".*Private.*", "Private", levels(cleanloans$Name))
levels(cleanloans$Name) <- gsub(".*Fargo.*", "Private", levels(cleanloans$Name))
levels(cleanloans$Name) <- gsub(".*Sallie.*", "Private", levels(cleanloans$Name))
levels(cleanloans$Name) <- gsub(".*Stafford.*|.*STAFFORD.*|.*stafford.*", "Federal", levels(cleanloans$Name))
levels(cleanloans$Name) <- gsub(".*Direct.*|.*direct.*|.*DIRECT.*", "Federal", levels(cleanloans$Name))
levels(cleanloans$Name) <- gsub(".*Federal.*|.*federal.*|.*FEDERAL.*", "Federal", levels(cleanloans$Name))
levels(cleanloans$Name) <- gsub(".*Signature.*|.*signature.*|.*SIGNATURE.*", "Federal", levels(cleanloans$Name))
levels(cleanloans$Name) <- gsub(".*subsidized.*|.*Subsidized.*|.*SUBSIDIZED.*", "Federal", levels(cleanloans$Name))
levels(cleanloans$Name) <- gsub(".*PLUS.*|.*plus.*|.*Plus.*", "Federal", levels(cleanloans$Name))
levels(cleanloans$Name) <- gsub(".*FFEL.*|.*ffel.*|.*Ffel.*", "Federal", levels(cleanloans$Name))
levels(cleanloans$Name) <- gsub(".*CONSOLIDATION.*|.*consolidation.*|.*Consolidation.*", "Federal", levels(cleanloans$Name))

OtherLoans <- !(cleanloans$Name %in% c("Private","Federal"))

cleanloans$Name[OtherLoans]<- "Private"

cleanloans$Name <- factor(cleanloans$Name)

levels(factor(cleanloans$Name))

sort(table(cleanloans$Name))
```

From here we can see that federal loans outnumber private loans by more than 10x in the Student Loan Hero user dataset.  

```{r echo=FALSE, results='hide'}
#Reducing Loan Statuses to just two
#table(cleanloans$Status)
levels(cleanloans$Status) <- gsub("DFR/GRC", "Repayment", levels(cleanloans$Status))
levels(cleanloans$Status) <- gsub("CANCELLED", "Repayment", levels(cleanloans$Status))
levels(cleanloans$Status) <- gsub("In School", "Repayment", levels(cleanloans$Status))
levels(cleanloans$Status) <- gsub("Interest Only", "Repayment", levels(cleanloans$Status))
levels(cleanloans$Status) <- gsub("IN SCHOOL", "Repayment", levels(cleanloans$Status))
levels(cleanloans$Status) <- gsub("RPM", "Repayment", levels(cleanloans$Status))
```
##Geographic Analysis
Now that we've blended data from the Carnegie Mellon University Classification dataset with the Student Loan Hero users dataset I wanted to take a look at how Student Loan Hero users differed by their state of residency.
```{r, echo=FALSE, results='hide'}
cleanloans$User.DOB <- mdy(cleanloans$User.DOB)
cleanloans$User.ID.. <- as.factor(cleanloans$User.ID..)
cleanloans$Loan.Disbursement.Date <- mdy(cleanloans$Loan.Disbursement.Date)
cleanloans$Joint.Federal.Income.Tax. <- as.character(cleanloans$Joint.Federal.Income.Tax.)

#In order to use choropleth maps, I need the state names
data("state.regions")
```

```{r, warning=FALSE}
#Loans per state
state_loans <- cleanloans%>%group_by(abb=univstate)%>%dplyr::summarize(value=n())
state_loans <- state_loans[complete.cases(state_loans),]
state_loans <- left_join(state_loans, state.regions, by='abb')
state_choropleth(state_loans, title="Loans Per State")
```

A quick look at where Student Loan Hero Users' loans originated from.  
  

```{r, warning=FALSE}
#Defaulted Loans as per status
status <- 'Default'
state_loans <- cleanloans%>%filter(Status==status)%>%group_by(abb=univstate)%>%dplyr::summarize(value=n())
state_loans <- state_loans[complete.cases(state_loans),]
state_loans <- left_join(state_loans, state.regions, by='abb')
state_choropleth(state_loans,title=paste0("Loans As Per Status:",status))
```

A look at where Student Loan Hero user's defaulted loans originated from.  Note there are a number of states that have no defaulted loans from Student Loan Hero users.
  
```{r, warning=FALSE}

#Loans as per rate of interest
state_loans <- cleanloans%>%group_by(abb=univstate)%>%dplyr::summarize(value=mean(Rate))
state_loans <- state_loans[complete.cases(state_loans),]
state_loans <- left_join(state_loans, state.regions, by='abb')
state_choropleth(state_loans,title="Average Rate of Interest")
```

A look at the average rate of interest on Student Loan Hero User's student loans by state.  It's interesting to note that there are a number of states that appear to have high interest rates relative to other states, but as displayed in the previous chloropleth map they in fact have no defaulted loans from Student Loan Hero users.  This goes contrary to the belief and line of thinking that higher student loan interest rates contribute to higher default rates among graduates.

##Interest Rate Analysis

###Average Interest rate of student loans by rate type (fixed vs variable)
```{r}
#AVG INTEREST RATES by Fixed vs Variable Interest Rates
#Type <- 'Fixed'
loan_rates <- cleanloans%>%group_by(Type)%>%dplyr::summarize(value=mean(Rate))

ggplot(loan_rates, (aes(x = Type, y = value, fill=Type))) + geom_bar(stat="identity") + scale_fill_manual(values=c("#55967e", "#6d819c")) +  geom_text(aes(x=Type, y=value +0.3, label=paste(format(value, digits=3),"%"))) + scale_x_discrete(breaks=NULL, labels=waiver()) #scale_y_continuous(labels = scales::percent_format())
```

This is an interesting look at the average interest rates of a Student Loan Hero user's loan, broken out by variable and fixed interest rates.  Typically, variable interest rates start off lower than fixed interest rates at time of origination and are adjusted as LIBOR is updated.  Since the financial crisis of 2007-2008 rates have been kept artifically low, though as of late have been on the rise.  

###Average interest rate of student loans by status (default vs repayment)

```{r}
#AVG INTEREST RATES by Status
loan_rates_status <- cleanloans%>%group_by(Status)%>%dplyr::summarize(value=mean(Rate))
 
ggplot(loan_rates_status, (aes(x = Status, y = value, fill = Status))) + geom_bar(stat="identity") + theme_fivethirtyeight() + scale_fill_manual(values=c("#DE6449", "#00b9f1")) + geom_text(aes(x=Status, y=value +0.3, label=paste(format(value, digits=3),"%"))) + scale_x_discrete(breaks = NULL)
```

Again, in further examining the role interest rates may or may not play in contributing to student loan default rates here's how the breakdown of those interest rates of those in default and those in repayment stack up.
```{r}
interestratebox <- ggplot(cleanloans, aes(cleanloans$Rate, cleanloans$Status))

interestratebox + geom_boxplot() + geom_jitter(width = 0.2,aes(col=Status)) + scale_color_manual(values=c("#DE6449", "#00b9f1")) + coord_flip()  +  xlab("Interest Rate") + ylab("Loan Stats")
```

###Average interest rate of student loans by loan type (federal vs private)
```{r}
#AVG INTEREST RATES by Loan Type (Federal or Private)
loan_rates_name <- cleanloans%>%group_by(Name)%>%dplyr::summarize(value=mean(Rate))

ggplot(loan_rates_name, (aes(x = Name, y = value, fill = Name))) + geom_bar(stat="identity") + scale_fill_manual(values=c("#c46b13", "#3f99b5")) + geom_text(aes(x=Name, y=value +0.3, label=paste(format(value, digits=3),"%"))) + scale_x_discrete(breaks = NULL) +ylab("Interest Rate") +xlab("Loan Type")
```

###Average balance of a users' student loans by loan type (federal vs private)
```{r}
#AVG BALANCE by Loan Type (Federal or Private)
loan_balance_name <- cleanloans%>%group_by(Name)%>%dplyr::summarize(value=mean(Original.Principal))

ggplot(loan_balance_name, (aes(x = Name, y = value, fill= Name))) + geom_bar(stat="identity") + scale_fill_manual(values=c("#c46b13", "#3f99b5")) + geom_text(aes(x=Name, y=value, label=paste(format(value, digits=4))),vjust=-.3) + scale_x_discrete(breaks = NULL) + ylab("Loan Balance") +xlab("Loan Type")

```

###Average balance of a users' student loans by rate type (fixed vs variable)
```{r}
#AVG BALANCE by Rate Type (Fixed vs Variable)
loan_balance_type <- cleanloans%>%group_by(Type)%>%dplyr::summarize(value=mean(Original.Principal))

ggplot(loan_balance_type, (aes(x = Type, y = value, fill= Type))) + geom_bar(stat="identity") + theme_fivethirtyeight() + scale_fill_manual(values=c("#55967e", "#6d819c")) + geom_text(aes(x=Type, y=value, label=paste(format(value, digits=4))),vjust=-.3) + scale_x_discrete(breaks = NULL) + ylab("Loan Balance") +xlab("Loan Type")
```

###Average balance of users' student loans by status (repayment vs default)
```{r}
#AVG BALANCE by Status
loan_balance_status <- cleanloans%>%group_by(Status)%>%dplyr::summarize(value=mean(Original.Principal))

ggplot(loan_balance_status, (aes(x = Status, y = value, fill = Status))) + geom_bar(stat="identity") + theme_fivethirtyeight() + scale_fill_manual(values=c("#DE6449", "#00b9f1")) + geom_text(aes(x=Status, y=value, label=paste(format(value, digits=4))),vjust=-.3) + scale_x_discrete(breaks = NULL) + scale_y_continuous(labels=dollar)
```

###Status (default vs repayment) of users' student loans by major
```{r}
#Status by Majors
ggplot(cleanloans, aes(Major, fill=Status)) + theme_fivethirtyeight() + geom_bar()+theme(legend.position = "right", legend.direction = "vertical", axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_manual(values=c("#DE6449", "#00b9f1"))
```

###Loan type (fixed vs variable) of user's student loans by major
```{r}
#Fixed/Variable Loans by Major
ggplot(cleanloans, aes(Major, fill=Type))+ theme_fivethirtyeight() + geom_bar() + theme(legend.position = "right", legend.direction = "vertical", axis.text.x = element_text(angle = 90, hjust = 1))  + scale_fill_manual(values=c("#55967e", "#6d819c"))
```

#Predicting Student Loan Default Rates
##Machine Learning Algorithm - Random Forest
The goal of our prediction model was to determine whether the loan status of a given borrower would be "default" or "repayment".  In determining the best machine learning algorithm to apply to our classifier model Random Forest was chosen for its accuracy, efficiency, methods available for balancing errors in class imbalance cases, and robust variable importance estimates.

##Unbalanced Dataset / Class Imbalance Issue Undersampling Data
```{r echo="FALSE"}
loansdef.mod <- fread("slhloansprojectcleaned.csv")
str(loansdef.mod)

#Convert to factor variables
cols <- c("Name","Status","Type","Education.Degree","College",
          "Major","Employment.Status","Employer.Type","Profession",
          "State.of.Residency","Credit.Score","totalusercurrentbalbucket",
          "loancurrentbalbucket","origprincipaluserbucket","originalprincipalloanbucket",
          "univlibarts","univwomens","univhsi","univtribal","univhbcu",
          "univmedical","univenrprofile","univlocale","univobereg","univstate","univctrl")

#Undersampling Data
loans_under_balanced <- ovun.sample(Status ~ ., data = loansdef.mod, method = "under", N = 100, seed = 1)$data


setDT(loans_under_balanced)[, (cols):= lapply(.SD, factor), .SDcols=cols]
```
The Student Loan Hero dataset is inherently unbalanced, with the vast majority of statuses being in repayment, and only a very small minority in default.  In order to optimize our random forest algorithm to be as accurate as possible, it was decided to undersample the majority class, or the instances of statuses in repayment.  This balanced the frequencies of default to repayment more closely.

##Training and Test Sets
Once undersampled, the dataset was split in order to train and then test the model.  I settled on a 70/30 split of training to testing for the dataset.  
```{r}
#Select the columns we want
loans1 <- dplyr::select(loans_under_balanced, -V1,-User.ID..,-X,-User.DOB,-Loan.ID..,-College,
                 -Joint.Federal.Income.Tax.,-Joint.Federal.Income.Tax.,-univstate,-univtribal)

loans1$Family.Size <- as.numeric(loans1$Family.Size)
#Divide into training and test datasets
set.seed(666)
split <- base::sample(nrow(loans1), floor(0.7*nrow(loans1)))
train <- loans1[split,]
test <- loans1[-split,]
```

##Training the Random Forest Model
The random forest model was then run on the training data set

```{r}
model <- randomForest(Status ~ ., data=train,
                      ntree=500,
                      mtry=6,
                      importance=TRUE,
                      na.action = na.roughfix,
                      replace=FALSE)

model
```
Our model has a 

##Out-of-bag Error and ROC Curve

```{r}
#Plot the AUC using pROC
roc(model$y, as.numeric(model$predicted))
```

```{r}
#Plot the error rate
plot(model, main="")
legend("topright", c("OOB", "a", "b"), text.col=1:6, lty=1:3, col=1:3)
title(main="Error Rates Random Forest-Loans Data-Undersampled")
```

```{r}
#ROC Curve
library(verification)
aucc <- roc.area(as.integer(train$Status)-1,model$votes[,2])$A
roc.plot(as.integer(train$Status)-1,model$votes[,2], main="")
legend("bottomright", bty="n",sprintf("Area Under the Curve (AUC) = %1.3f", aucc))
title(main="OOB ROC Curve Random Forest-Loans Data-Undersampled")
```

##Running the model on the test data

```{r}
#Test the model on the test data
outcome <- predict(model, test)
base::table(test$Status,outcome, dnn=c("Actual", "Predicted"))
```

##Variable Importance
```{r echo="FALSE", results="HIDE"}
#Variable Importance
rn <- round(importance(model), 2)
head(rn[order(rn[,3], decreasing=TRUE),], 5)
```
A quick look at the top five factors in predicting whether a user will fall into the "default" status shows that according to our random forest model credit score is the factor with the highest importance when predicting whether a borrower will default.  Followed by the profile of their university (2-year only undergrade, 4-yr undergrad, medical university, etc.), then by the bucketed amount of loans they initially borrowed, then by what the borrower's current balance outstanding is, then, closely rleated to the third factor of importance (origprinciapluserbucket) by the actualy amount of loans they initially borrowed.

```{r, fig.width=10,fig.height=11}
#Variable Importance Plot
varImpPlot(model, main="")
title(main="Variable Importance Random Forest - Loans Data - Undersampled")
```

#Next Steps and Recommendations
* With the basic model for predicting whether or not a user will find themselves in "default", Student Loan Hero could better target users at risk of defaulting on their student loans to deliver specific advice via email, phone, or direct mail, proactively monitor high-risk users, and better tailor in-app messages and advertising campaigns to better serve users based on their likelihood of default.

* Student Loan Hero could also develop a proprietary score or grade that is assigned to each user based on the health of their profile according to our default model.  Perhaps an A-F rating of how a user is doing on their debt payoff journey.  This could be used as an user acquisition tool, or for press and outreach.

* With the amount of users and loans available in the constantly growing Student Loan Hero user database, Student Loan Hero could develop an underwriting model to share with refinancing partners in an effort to obtain optimized underwriting models for Student Loan Hero users at their refinancing partners, or simply to allow our partners to tweak their own underwriting criteria and models.

#Acknowledgements
I would like to thank Dhiraj Khanna for his continued support in preparing this report and project, especially for the numerous sugestions surrounding how to work with unbalanced datasets and working with random forest models. 